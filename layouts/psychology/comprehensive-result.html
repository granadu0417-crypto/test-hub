{{ define "head" }}
<!-- Chart.js for Radar Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- html2canvas for Image Download -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Psychology Result Page Styles -->
<style>
  .psychology-result-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }

  .result-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    color: white;
  }

  .result-badge {
    font-size: 4rem;
    margin-bottom: 10px;
  }

  .result-title {
    font-size: 2.5rem;
    margin: 10px 0;
    font-weight: bold;
  }

  .result-subtitle {
    font-size: 1.2rem;
    opacity: 0.9;
  }

  .overall-score {
    margin: 20px 0;
    padding: 20px;
    background: white;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .score-number {
    font-size: 4rem;
    font-weight: bold;
    color: #667eea;
    margin: 10px 0;
  }

  .radar-chart-section {
    margin: 30px 0;
    padding: 30px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .chart-container {
    position: relative;
    height: 400px;
    margin: 20px auto;
  }

  .dimension-scores {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 30px 0;
  }

  .dimension-card {
    padding: 20px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-left: 5px solid;
  }

  .dimension-name {
    font-size: 1.1rem;
    font-weight: bold;
    margin-bottom: 10px;
  }

  .dimension-score-bar {
    width: 100%;
    height: 30px;
    background: #f0f0f0;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
  }

  .dimension-score-fill {
    height: 100%;
    border-radius: 15px;
    transition: width 1s ease-out;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    color: white;
    font-weight: bold;
  }

  .analysis-section {
    margin: 30px 0;
    padding: 30px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .section-title {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 20px;
    color: #333;
    text-align: center;
  }

  .strength-weakness-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }

  .strength-card, .weakness-card {
    padding: 20px;
    border-radius: 10px;
  }

  .strength-card {
    background: #d4edda;
    border-left: 5px solid #28a745;
  }

  .weakness-card {
    background: #f8d7da;
    border-left: 5px solid #dc3545;
  }

  .risk-alert {
    padding: 20px;
    background: #fff3cd;
    border-left: 5px solid #ffc107;
    border-radius: 10px;
    margin: 15px 0;
  }

  .risk-alert.high {
    background: #f8d7da;
    border-left-color: #dc3545;
  }

  .recommendations {
    margin: 20px 0;
  }

  .recommendation-item {
    padding: 15px;
    margin: 10px 0;
    background: #e7f3ff;
    border-left: 5px solid #2196F3;
    border-radius: 10px;
  }

  .crisis-support {
    margin: 30px 0;
    padding: 25px;
    background: #ffe5e5;
    border: 2px solid #ff4444;
    border-radius: 15px;
  }

  .share-section {
    margin: 30px 0;
    padding: 25px;
    background: white;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .btn-share {
    padding: 12px 30px;
    border: none;
    border-radius: 25px;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .btn-share:hover {
    transform: scale(1.05);
  }
</style>

<!-- OG Tags for Social Sharing -->
<meta property="og:type" content="article">
<meta property="og:url" content="{{ .Permalink }}">
<meta property="og:title" content="{{ .Title }}">
<meta property="og:description" content="나의 종합 심리 분석 결과를 확인해보세요!">
{{ end }}

{{ define "main" }}
<div class="psychology-result-container">
  <!-- Result Header -->
  <div class="result-header">
    <div class="result-badge" id="resultBadge">🧠</div>
    <h1 class="result-title" id="resultTitle">심리 분석 결과</h1>
    <p class="result-subtitle" id="resultSubtitle">당신의 심리 상태를 분석했습니다</p>
  </div>

  <!-- Overall Score -->
  <div class="overall-score">
    <h3>종합 점수</h3>
    <div class="score-number" id="overallScore">--</div>
    <p id="scoreDescription">점수를 계산하는 중...</p>
  </div>

  <!-- Radar Chart -->
  <div class="radar-chart-section">
    <h2 class="section-title">📊 5대 차원 분석</h2>
    <div class="chart-container">
      <canvas id="radarChart"></canvas>
    </div>
  </div>

  <!-- Dimension Scores -->
  <div class="dimension-scores" id="dimensionScores">
    <!-- Populated by JavaScript -->
  </div>

  <!-- Strengths & Weaknesses -->
  <div class="analysis-section">
    <h2 class="section-title">💪 강점과 약점</h2>
    <div class="strength-weakness-grid" id="strengthWeakness">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <!-- Risk Alerts -->
  <div class="analysis-section" id="riskSection" style="display: none;">
    <h2 class="section-title">⚠️ 주의가 필요한 영역</h2>
    <div id="riskAlerts">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <!-- Recommendations -->
  <div class="analysis-section">
    <h2 class="section-title">💡 개선 제안</h2>
    <div class="recommendations" id="recommendations">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <!-- Crisis Support (shown if critical risks detected) -->
  <div class="crisis-support" id="crisisSupport" style="display: none;">
    <h3>🆘 긴급 지원이 필요하신가요?</h3>
    <p>심리적 어려움을 겪고 계시다면, 전문가의 도움을 받는 것을 권장합니다.</p>
    <div class="hotline-info">
      <div class="hotline-card">
        <div>💚 정신건강 위기상담</div>
        <div class="hotline-number">1577-0199</div>
        <small>24시간 운영</small>
      </div>
      <div class="hotline-card">
        <div>📞 자살예방 상담</div>
        <div class="hotline-number">1393</div>
        <small>24시간 운영</small>
      </div>
      <div class="hotline-card">
        <div>🏥 정신건강복지센터</div>
        <div class="hotline-number">1577-0199</div>
        <small>지역별 센터 안내</small>
      </div>
    </div>
  </div>

  <!-- Share Section -->
  <div class="share-section">
    <h3>💬 결과를 공유하기</h3>
    <p>친구들도 자신의 심리 상태를 확인해보세요!</p>
    <div class="share-buttons">
      <button class="btn-share" style="background: #FF6B6B; color: white;" onclick="downloadResultImage()">
        📸 이미지로 저장
      </button>
      <button class="btn-share" style="background: #3b5998; color: white;" onclick="shareFacebook()">
        📘 페이스북 공유
      </button>
      <button class="btn-share" style="background: #00acee; color: white;" onclick="shareTwitter()">
        🐦 트위터 공유
      </button>
      <button class="btn-share" style="background: #25D366; color: white;" onclick="copyLink(event)">
        🔗 링크 복사
      </button>
    </div>
  </div>

  <!-- Back to Test -->
  <div style="text-align: center; margin: 30px 0;">
    <a href="/psychology-center/comprehensive-analysis/" 
       style="display: inline-block; padding: 15px 40px; background: #667eea; color: white; 
              text-decoration: none; border-radius: 25px; font-weight: bold;">
      🔄 테스트 다시 하기
    </a>
  </div>
</div>
{{ end }}

{{ define "scripts" }}
<script src="/js/psychology-calculator.js"></script>
<script>
// Get test data and user answers from sessionStorage
const testDataJson = sessionStorage.getItem('psychologyTestData');
const answersJson = sessionStorage.getItem('psychologyAnswers');

if (!testDataJson || !answersJson) {
  alert('테스트 데이터를 찾을 수 없습니다. 테스트를 다시 시작해주세요.');
  window.location.href = '/psychology-center/comprehensive-analysis/';
}

const testData = JSON.parse(testDataJson);
const answers = JSON.parse(answersJson);

// Calculate results
const calculator = new PsychologyCalculator(testData);
const results = calculator.calculateResults(answers);

console.log('Analysis Results:', results);

// Update header
document.getElementById('resultBadge').textContent = getResultBadge(results.resultType);
document.getElementById('resultTitle').textContent = getResultTitle(results.resultType);
document.getElementById('resultSubtitle').textContent = getResultSubtitle(results.resultType);

// Update overall score
document.getElementById('overallScore').textContent = results.overallScore;
document.getElementById('scoreDescription').textContent = getScoreDescription(results.overallScore);

// Render radar chart
renderRadarChart(results.radarChartData);

// Display dimension scores
displayDimensionScores(results.dimensionScores);

// Display strengths and weaknesses
displayStrengthsWeaknesses(results.strengths, results.weaknesses);

// Display risks if any
if (results.risks.length > 0) {
  displayRisks(results.risks);
}

// Display recommendations
const recommendations = calculator.getRecommendations(results.dimensionScores, results.risks);
displayRecommendations(recommendations);

// Show crisis support if critical
const hasCriticalRisk = results.risks.some(r => r.severity === 'high');
if (hasCriticalRisk || results.overallScore < 35) {
  document.getElementById('crisisSupport').style.display = 'block';
}

/**
 * Render Chart.js radar chart
 */
function renderRadarChart(chartData) {
  const ctx = document.getElementById('radarChart').getContext('2d');
  
  new Chart(ctx, {
    type: 'radar',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: {
            stepSize: 20
          }
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
}

/**
 * Display dimension scores as cards with progress bars
 */
function displayDimensionScores(dimensionScores) {
  const container = document.getElementById('dimensionScores');
  container.innerHTML = '';
  
  Object.entries(dimensionScores).forEach(([id, data]) => {
    const card = document.createElement('div');
    card.className = 'dimension-card';
    card.style.borderLeftColor = data.color;
    
    card.innerHTML = `
      <div class="dimension-name">${data.name}</div>
      <div class="dimension-score-bar">
        <div class="dimension-score-fill" 
             style="width: ${data.score}%; background: ${data.color};">
          ${data.score}점
        </div>
      </div>
    `;
    
    container.appendChild(card);
  });
}

/**
 * Display strengths and weaknesses
 */
function displayStrengthsWeaknesses(strengths, weaknesses) {
  const container = document.getElementById('strengthWeakness');
  container.innerHTML = '';
  
  // Strengths
  const strengthsDiv = document.createElement('div');
  strengthsDiv.innerHTML = '<h3>💪 강점</h3>';
  strengths.forEach(s => {
    strengthsDiv.innerHTML += `
      <div class="strength-card">
        <strong>${s.name}</strong>: ${s.score}점<br>
        <small>이 영역에서 뛰어난 역량을 보이고 있습니다.</small>
      </div>
    `;
  });
  container.appendChild(strengthsDiv);
  
  // Weaknesses
  const weaknessesDiv = document.createElement('div');
  weaknessesDiv.innerHTML = '<h3>🎯 개선 영역</h3>';
  weaknesses.forEach(w => {
    weaknessesDiv.innerHTML += `
      <div class="weakness-card">
        <strong>${w.name}</strong>: ${w.score}점<br>
        <small>이 영역에 조금 더 관심을 기울이면 좋겠습니다.</small>
      </div>
    `;
  });
  container.appendChild(weaknessesDiv);
}

/**
 * Display risk alerts
 */
function displayRisks(risks) {
  if (risks.length === 0) return;
  
  const section = document.getElementById('riskSection');
  const container = document.getElementById('riskAlerts');
  section.style.display = 'block';
  container.innerHTML = '';
  
  risks.forEach(risk => {
    const alert = document.createElement('div');
    alert.className = `risk-alert ${risk.severity}`;
    alert.innerHTML = `
      <strong>${risk.severity === 'high' ? '⚠️ 높은 위험' : '⚡ 주의'}</strong><br>
      ${risk.message}
    `;
    container.appendChild(alert);
  });
}

/**
 * Display recommendations
 */
function displayRecommendations(recommendations) {
  const container = document.getElementById('recommendations');
  container.innerHTML = '';
  
  if (recommendations.length === 0) {
    container.innerHTML = '<p>현재 상태를 잘 유지하고 계십니다! 🎉</p>';
    return;
  }
  
  // Sort by priority
  const sorted = recommendations.sort((a, b) => {
    const priority = { high: 3, medium: 2, low: 1 };
    return priority[b.priority] - priority[a.priority];
  });
  
  sorted.forEach(rec => {
    const item = document.createElement('div');
    item.className = 'recommendation-item';
    item.innerHTML = `
      <strong>${rec.priority === 'high' ? '🔴' : '🟡'} ${rec.message}</strong><br>
      <small>💡 ${rec.action}</small>
    `;
    container.appendChild(item);
  });
}

/**
 * Get result badge emoji based on type
 */
function getResultBadge(type) {
  const badges = {
    'thriving': '🌟',
    'flourishing': '🌱',
    'stable': '⚖️',
    'struggling': '🔄',
    'critical': '🆘'
  };
  return badges[type] || '🧠';
}

/**
 * Get result title based on type
 */
function getResultTitle(type) {
  const titles = {
    'thriving': '번영하는 삶',
    'flourishing': '성장하는 삶',
    'stable': '안정적인 삶',
    'struggling': '도전받는 삶',
    'critical': '위기의 삶'
  };
  return titles[type] || '심리 분석 결과';
}

/**
 * Get result subtitle based on type
 */
function getResultSubtitle(type) {
  const subtitles = {
    'thriving': '모든 영역에서 균형잡힌 성장',
    'flourishing': '대부분의 영역에서 건강한 상태',
    'stable': '평균적이고 안정적인 상태',
    'struggling': '여러 영역에서 어려움을 겪고 있음',
    'critical': '즉각적인 관심과 지원이 필요'
  };
  return subtitles[type] || '';
}

/**
 * Get score description
 */
function getScoreDescription(score) {
  if (score >= 80) return '매우 건강한 심리 상태입니다!';
  if (score >= 65) return '전반적으로 좋은 상태입니다.';
  if (score >= 50) return '평균적인 수준입니다.';
  if (score >= 35) return '개선이 필요한 상태입니다.';
  return '전문가의 도움이 권장됩니다.';
}

/**
 * Social sharing functions
 */
function shareFacebook() {
  const url = encodeURIComponent(window.location.href);
  const text = encodeURIComponent('나의 종합 심리 분석 결과를 확인했어요! 당신도 해보세요!');
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank', 'width=600,height=400');
}

function shareTwitter() {
  const url = encodeURIComponent(window.location.href);
  const text = encodeURIComponent('나의 종합 심리 분석 결과! 5가지 차원에서 내 마음을 분석했어요 🧠✨');
  window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
}

function copyLink(event) {
  const url = window.location.href;
  const text = `종합 심리 분석 결과\n\n${url}`;

  navigator.clipboard.writeText(text).then(() => {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.innerHTML = '✅ 복사 완료!';
    setTimeout(() => {
      btn.innerHTML = originalText;
    }, 2000);
  }).catch(err => {
    alert('링크 복사에 실패했습니다: ' + err);
  });
}

/**
 * Download result as image
 */
function downloadResultImage() {
  const btn = event.currentTarget;
  const originalText = btn.innerHTML;
  btn.innerHTML = '📸 생성 중...';
  btn.disabled = true;

  // Get the result container (excluding share buttons and back button)
  const container = document.querySelector('.psychology-result-container');

  // Temporarily hide share section and back button
  const shareSection = document.querySelector('.share-section');
  const backButton = shareSection.nextElementSibling;
  shareSection.style.display = 'none';
  backButton.style.display = 'none';

  html2canvas(container, {
    backgroundColor: '#f5f5f5',
    scale: 2, // Higher quality
    logging: false,
    useCORS: true
  }).then(canvas => {
    // Restore hidden elements
    shareSection.style.display = 'block';
    backButton.style.display = 'block';
    btn.innerHTML = originalText;
    btn.disabled = false;

    // Convert to blob and download
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `심리분석결과_${new Date().toISOString().slice(0,10)}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Show success message
      btn.innerHTML = '✅ 저장 완료!';
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    });
  }).catch(err => {
    shareSection.style.display = 'block';
    backButton.style.display = 'block';
    btn.innerHTML = originalText;
    btn.disabled = false;
    alert('이미지 생성에 실패했습니다: ' + err.message);
  });
}
</script>
{{ end }}
