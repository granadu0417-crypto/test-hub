{{ define "head" }}
<!-- Chart.js for Radar Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- html2canvas for Image Download -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Psychology Result Page Styles -->
<style>
  .psychology-result-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }

  .result-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    color: white;
  }

  .result-badge {
    font-size: 4rem;
    margin-bottom: 10px;
  }

  .result-title {
    font-size: 2.5rem;
    margin: 10px 0;
    font-weight: bold;
  }

  .result-subtitle {
    font-size: 1.2rem;
    opacity: 0.9;
  }

  .overall-score {
    margin: 20px 0;
    padding: 20px;
    background: white;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .score-number {
    font-size: 4rem;
    font-weight: bold;
    color: #667eea;
    margin: 10px 0;
  }

  .radar-chart-section {
    margin: 30px 0;
    padding: 30px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .chart-container {
    position: relative;
    height: 400px;
    margin: 20px auto;
  }

  .dimension-scores {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 30px 0;
  }

  .dimension-card {
    padding: 20px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-left: 5px solid;
  }

  .dimension-name {
    font-size: 1.1rem;
    font-weight: bold;
    margin-bottom: 10px;
  }

  .dimension-score-bar {
    width: 100%;
    height: 30px;
    background: #f0f0f0;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
  }

  .dimension-score-fill {
    height: 100%;
    border-radius: 15px;
    transition: width 1s ease-out;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    color: white;
    font-weight: bold;
  }

  .analysis-section {
    margin: 30px 0;
    padding: 30px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .section-title {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 20px;
    color: #333;
    text-align: center;
  }

  .strength-weakness-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }

  .strength-card, .weakness-card {
    padding: 20px;
    border-radius: 10px;
  }

  .strength-card {
    background: #d4edda;
    border-left: 5px solid #28a745;
  }

  .weakness-card {
    background: #f8d7da;
    border-left: 5px solid #dc3545;
  }

  .risk-alert {
    padding: 20px;
    background: #fff3cd;
    border-left: 5px solid #ffc107;
    border-radius: 10px;
    margin: 15px 0;
  }

  .risk-alert.high {
    background: #f8d7da;
    border-left-color: #dc3545;
  }

  .recommendations {
    margin: 20px 0;
  }

  .recommendation-item {
    padding: 15px;
    margin: 10px 0;
    background: #e7f3ff;
    border-left: 5px solid #2196F3;
    border-radius: 10px;
  }

  .crisis-support {
    margin: 30px 0;
    padding: 25px;
    background: #ffe5e5;
    border: 2px solid #ff4444;
    border-radius: 15px;
  }

  .share-section {
    margin: 30px 0;
    padding: 25px;
    background: white;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .btn-share {
    padding: 12px 30px;
    border: none;
    border-radius: 25px;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .btn-share:hover {
    transform: scale(1.05);
  }
</style>

<!-- OG Tags for Social Sharing -->
<meta property="og:type" content="article">
<meta property="og:url" content="{{ .Permalink }}">
<meta property="og:title" content="{{ .Title }}">
<meta property="og:description" content="ë‚˜ì˜ ì¢…í•© ì‹¬ë¦¬ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!">
{{ end }}

{{ define "main" }}
<div class="psychology-result-container">
  <!-- Result Header -->
  <div class="result-header">
    <div class="result-badge" id="resultBadge">ğŸ§ </div>
    <h1 class="result-title" id="resultTitle">ì‹¬ë¦¬ ë¶„ì„ ê²°ê³¼</h1>
    <p class="result-subtitle" id="resultSubtitle">ë‹¹ì‹ ì˜ ì‹¬ë¦¬ ìƒíƒœë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤</p>
  </div>

  <!-- Overall Score -->
  <div class="overall-score">
    <h3>ì¢…í•© ì ìˆ˜</h3>
    <div class="score-number" id="overallScore">--</div>
    <p id="scoreDescription">ì ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...</p>
  </div>

  <!-- Radar Chart -->
  <div class="radar-chart-section">
    <h2 class="section-title">ğŸ“Š 5ëŒ€ ì°¨ì› ë¶„ì„</h2>
    <div class="chart-container">
      <canvas id="radarChart"></canvas>
    </div>
  </div>

  <!-- Dimension Scores -->
  <div class="dimension-scores" id="dimensionScores">
    <!-- Populated by JavaScript -->
  </div>

  <!-- Strengths & Weaknesses -->
  <div class="analysis-section">
    <h2 class="section-title">ğŸ’ª ê°•ì ê³¼ ì•½ì </h2>
    <div class="strength-weakness-grid" id="strengthWeakness">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <!-- Risk Alerts -->
  <div class="analysis-section" id="riskSection" style="display: none;">
    <h2 class="section-title">âš ï¸ ì£¼ì˜ê°€ í•„ìš”í•œ ì˜ì—­</h2>
    <div id="riskAlerts">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <!-- Recommendations -->
  <div class="analysis-section">
    <h2 class="section-title">ğŸ’¡ ê°œì„  ì œì•ˆ</h2>
    <div class="recommendations" id="recommendations">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <!-- Crisis Support (shown if critical risks detected) -->
  <div class="crisis-support" id="crisisSupport" style="display: none;">
    <h3>ğŸ†˜ ê¸´ê¸‰ ì§€ì›ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</h3>
    <p>ì‹¬ë¦¬ì  ì–´ë ¤ì›€ì„ ê²ªê³  ê³„ì‹œë‹¤ë©´, ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
    <div class="hotline-info">
      <div class="hotline-card">
        <div>ğŸ’š ì •ì‹ ê±´ê°• ìœ„ê¸°ìƒë‹´</div>
        <div class="hotline-number">1577-0199</div>
        <small>24ì‹œê°„ ìš´ì˜</small>
      </div>
      <div class="hotline-card">
        <div>ğŸ“ ìì‚´ì˜ˆë°© ìƒë‹´</div>
        <div class="hotline-number">1393</div>
        <small>24ì‹œê°„ ìš´ì˜</small>
      </div>
      <div class="hotline-card">
        <div>ğŸ¥ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„°</div>
        <div class="hotline-number">1577-0199</div>
        <small>ì§€ì—­ë³„ ì„¼í„° ì•ˆë‚´</small>
      </div>
    </div>
  </div>

  <!-- Share Section -->
  <div class="share-section">
    <h3>ğŸ’¬ ê²°ê³¼ë¥¼ ê³µìœ í•˜ê¸°</h3>
    <p>ì¹œêµ¬ë“¤ë„ ìì‹ ì˜ ì‹¬ë¦¬ ìƒíƒœë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</p>
    <div class="share-buttons">
      <button class="btn-share" style="background: #FF6B6B; color: white;" onclick="downloadResultImage()">
        ğŸ“¸ ì´ë¯¸ì§€ë¡œ ì €ì¥
      </button>
      <button class="btn-share" style="background: #3b5998; color: white;" onclick="shareFacebook()">
        ğŸ“˜ í˜ì´ìŠ¤ë¶ ê³µìœ 
      </button>
      <button class="btn-share" style="background: #00acee; color: white;" onclick="shareTwitter()">
        ğŸ¦ íŠ¸ìœ„í„° ê³µìœ 
      </button>
      <button class="btn-share" style="background: #25D366; color: white;" onclick="copyLink(event)">
        ğŸ”— ë§í¬ ë³µì‚¬
      </button>
    </div>
  </div>

  <!-- Back to Test -->
  <div style="text-align: center; margin: 30px 0;">
    <a href="/psychology-center/comprehensive-analysis/" 
       style="display: inline-block; padding: 15px 40px; background: #667eea; color: white; 
              text-decoration: none; border-radius: 25px; font-weight: bold;">
      ğŸ”„ í…ŒìŠ¤íŠ¸ ë‹¤ì‹œ í•˜ê¸°
    </a>
  </div>
</div>
{{ end }}

{{ define "scripts" }}
<script src="/js/psychology-calculator.js"></script>
<script>
// Get test data and user answers from sessionStorage
const testDataJson = sessionStorage.getItem('psychologyTestData');
const answersJson = sessionStorage.getItem('psychologyAnswers');

if (!testDataJson || !answersJson) {
  alert('í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”.');
  window.location.href = '/psychology-center/comprehensive-analysis/';
}

const testData = JSON.parse(testDataJson);
const answers = JSON.parse(answersJson);

// Calculate results
const calculator = new PsychologyCalculator(testData);
const results = calculator.calculateResults(answers);

console.log('Analysis Results:', results);

// Update header
document.getElementById('resultBadge').textContent = getResultBadge(results.resultType);
document.getElementById('resultTitle').textContent = getResultTitle(results.resultType);
document.getElementById('resultSubtitle').textContent = getResultSubtitle(results.resultType);

// Update overall score
document.getElementById('overallScore').textContent = results.overallScore;
document.getElementById('scoreDescription').textContent = getScoreDescription(results.overallScore);

// Render radar chart
renderRadarChart(results.radarChartData);

// Display dimension scores
displayDimensionScores(results.dimensionScores);

// Display strengths and weaknesses
displayStrengthsWeaknesses(results.strengths, results.weaknesses);

// Display risks if any
if (results.risks.length > 0) {
  displayRisks(results.risks);
}

// Display recommendations
const recommendations = calculator.getRecommendations(results.dimensionScores, results.risks);
displayRecommendations(recommendations);

// Show crisis support if critical
const hasCriticalRisk = results.risks.some(r => r.severity === 'high');
if (hasCriticalRisk || results.overallScore < 35) {
  document.getElementById('crisisSupport').style.display = 'block';
}

/**
 * Render Chart.js radar chart
 */
function renderRadarChart(chartData) {
  const ctx = document.getElementById('radarChart').getContext('2d');
  
  new Chart(ctx, {
    type: 'radar',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: {
            stepSize: 20
          }
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
}

/**
 * Display dimension scores as cards with progress bars
 */
function displayDimensionScores(dimensionScores) {
  const container = document.getElementById('dimensionScores');
  container.innerHTML = '';
  
  Object.entries(dimensionScores).forEach(([id, data]) => {
    const card = document.createElement('div');
    card.className = 'dimension-card';
    card.style.borderLeftColor = data.color;
    
    card.innerHTML = `
      <div class="dimension-name">${data.name}</div>
      <div class="dimension-score-bar">
        <div class="dimension-score-fill" 
             style="width: ${data.score}%; background: ${data.color};">
          ${data.score}ì 
        </div>
      </div>
    `;
    
    container.appendChild(card);
  });
}

/**
 * Display strengths and weaknesses
 */
function displayStrengthsWeaknesses(strengths, weaknesses) {
  const container = document.getElementById('strengthWeakness');
  container.innerHTML = '';
  
  // Strengths
  const strengthsDiv = document.createElement('div');
  strengthsDiv.innerHTML = '<h3>ğŸ’ª ê°•ì </h3>';
  strengths.forEach(s => {
    strengthsDiv.innerHTML += `
      <div class="strength-card">
        <strong>${s.name}</strong>: ${s.score}ì <br>
        <small>ì´ ì˜ì—­ì—ì„œ ë›°ì–´ë‚œ ì—­ëŸ‰ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.</small>
      </div>
    `;
  });
  container.appendChild(strengthsDiv);
  
  // Weaknesses
  const weaknessesDiv = document.createElement('div');
  weaknessesDiv.innerHTML = '<h3>ğŸ¯ ê°œì„  ì˜ì—­</h3>';
  weaknesses.forEach(w => {
    weaknessesDiv.innerHTML += `
      <div class="weakness-card">
        <strong>${w.name}</strong>: ${w.score}ì <br>
        <small>ì´ ì˜ì—­ì— ì¡°ê¸ˆ ë” ê´€ì‹¬ì„ ê¸°ìš¸ì´ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.</small>
      </div>
    `;
  });
  container.appendChild(weaknessesDiv);
}

/**
 * Display risk alerts
 */
function displayRisks(risks) {
  if (risks.length === 0) return;
  
  const section = document.getElementById('riskSection');
  const container = document.getElementById('riskAlerts');
  section.style.display = 'block';
  container.innerHTML = '';
  
  risks.forEach(risk => {
    const alert = document.createElement('div');
    alert.className = `risk-alert ${risk.severity}`;
    alert.innerHTML = `
      <strong>${risk.severity === 'high' ? 'âš ï¸ ë†’ì€ ìœ„í—˜' : 'âš¡ ì£¼ì˜'}</strong><br>
      ${risk.message}
    `;
    container.appendChild(alert);
  });
}

/**
 * Display recommendations
 */
function displayRecommendations(recommendations) {
  const container = document.getElementById('recommendations');
  container.innerHTML = '';
  
  if (recommendations.length === 0) {
    container.innerHTML = '<p>í˜„ì¬ ìƒíƒœë¥¼ ì˜ ìœ ì§€í•˜ê³  ê³„ì‹­ë‹ˆë‹¤! ğŸ‰</p>';
    return;
  }
  
  // Sort by priority
  const sorted = recommendations.sort((a, b) => {
    const priority = { high: 3, medium: 2, low: 1 };
    return priority[b.priority] - priority[a.priority];
  });
  
  sorted.forEach(rec => {
    const item = document.createElement('div');
    item.className = 'recommendation-item';
    item.innerHTML = `
      <strong>${rec.priority === 'high' ? 'ğŸ”´' : 'ğŸŸ¡'} ${rec.message}</strong><br>
      <small>ğŸ’¡ ${rec.action}</small>
    `;
    container.appendChild(item);
  });
}

/**
 * Get result badge emoji based on type
 */
function getResultBadge(type) {
  const badges = {
    'thriving': 'ğŸŒŸ',
    'flourishing': 'ğŸŒ±',
    'stable': 'âš–ï¸',
    'struggling': 'ğŸ”„',
    'critical': 'ğŸ†˜'
  };
  return badges[type] || 'ğŸ§ ';
}

/**
 * Get result title based on type
 */
function getResultTitle(type) {
  const titles = {
    'thriving': 'ë²ˆì˜í•˜ëŠ” ì‚¶',
    'flourishing': 'ì„±ì¥í•˜ëŠ” ì‚¶',
    'stable': 'ì•ˆì •ì ì¸ ì‚¶',
    'struggling': 'ë„ì „ë°›ëŠ” ì‚¶',
    'critical': 'ìœ„ê¸°ì˜ ì‚¶'
  };
  return titles[type] || 'ì‹¬ë¦¬ ë¶„ì„ ê²°ê³¼';
}

/**
 * Get result subtitle based on type
 */
function getResultSubtitle(type) {
  const subtitles = {
    'thriving': 'ëª¨ë“  ì˜ì—­ì—ì„œ ê· í˜•ì¡íŒ ì„±ì¥',
    'flourishing': 'ëŒ€ë¶€ë¶„ì˜ ì˜ì—­ì—ì„œ ê±´ê°•í•œ ìƒíƒœ',
    'stable': 'í‰ê· ì ì´ê³  ì•ˆì •ì ì¸ ìƒíƒœ',
    'struggling': 'ì—¬ëŸ¬ ì˜ì—­ì—ì„œ ì–´ë ¤ì›€ì„ ê²ªê³  ìˆìŒ',
    'critical': 'ì¦‰ê°ì ì¸ ê´€ì‹¬ê³¼ ì§€ì›ì´ í•„ìš”'
  };
  return subtitles[type] || '';
}

/**
 * Get score description
 */
function getScoreDescription(score) {
  if (score >= 80) return 'ë§¤ìš° ê±´ê°•í•œ ì‹¬ë¦¬ ìƒíƒœì…ë‹ˆë‹¤!';
  if (score >= 65) return 'ì „ë°˜ì ìœ¼ë¡œ ì¢‹ì€ ìƒíƒœì…ë‹ˆë‹¤.';
  if (score >= 50) return 'í‰ê· ì ì¸ ìˆ˜ì¤€ì…ë‹ˆë‹¤.';
  if (score >= 35) return 'ê°œì„ ì´ í•„ìš”í•œ ìƒíƒœì…ë‹ˆë‹¤.';
  return 'ì „ë¬¸ê°€ì˜ ë„ì›€ì´ ê¶Œì¥ë©ë‹ˆë‹¤.';
}

/**
 * Social sharing functions
 */
function shareFacebook() {
  const url = encodeURIComponent(window.location.href);
  const text = encodeURIComponent('ë‚˜ì˜ ì¢…í•© ì‹¬ë¦¬ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í–ˆì–´ìš”! ë‹¹ì‹ ë„ í•´ë³´ì„¸ìš”!');
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank', 'width=600,height=400');
}

function shareTwitter() {
  const url = encodeURIComponent(window.location.href);
  const text = encodeURIComponent('ë‚˜ì˜ ì¢…í•© ì‹¬ë¦¬ ë¶„ì„ ê²°ê³¼! 5ê°€ì§€ ì°¨ì›ì—ì„œ ë‚´ ë§ˆìŒì„ ë¶„ì„í–ˆì–´ìš” ğŸ§ âœ¨');
  window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
}

function copyLink(event) {
  const url = window.location.href;
  const text = `ì¢…í•© ì‹¬ë¦¬ ë¶„ì„ ê²°ê³¼\n\n${url}`;

  navigator.clipboard.writeText(text).then(() => {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
    setTimeout(() => {
      btn.innerHTML = originalText;
    }, 2000);
  }).catch(err => {
    alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err);
  });
}

/**
 * Download result as image
 */
function downloadResultImage() {
  const btn = event.currentTarget;
  const originalText = btn.innerHTML;
  btn.innerHTML = 'ğŸ“¸ ìƒì„± ì¤‘...';
  btn.disabled = true;

  // Get the result container (excluding share buttons and back button)
  const container = document.querySelector('.psychology-result-container');

  // Temporarily hide share section and back button
  const shareSection = document.querySelector('.share-section');
  const backButton = shareSection.nextElementSibling;
  shareSection.style.display = 'none';
  backButton.style.display = 'none';

  html2canvas(container, {
    backgroundColor: '#f5f5f5',
    scale: 2, // Higher quality
    logging: false,
    useCORS: true
  }).then(canvas => {
    // Restore hidden elements
    shareSection.style.display = 'block';
    backButton.style.display = 'block';
    btn.innerHTML = originalText;
    btn.disabled = false;

    // Convert to blob and download
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ì‹¬ë¦¬ë¶„ì„ê²°ê³¼_${new Date().toISOString().slice(0,10)}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Show success message
      btn.innerHTML = 'âœ… ì €ì¥ ì™„ë£Œ!';
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    });
  }).catch(err => {
    shareSection.style.display = 'block';
    backButton.style.display = 'block';
    btn.innerHTML = originalText;
    btn.disabled = false;
    alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
  });
}
</script>
{{ end }}
