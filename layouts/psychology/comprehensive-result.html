{{ define "head" }}
<!-- Chart.js for Radar Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<!-- html2canvas for Image Download -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Psychology Result Page Styles -->
<style>
  .psychology-result-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }

  .result-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    color: white;
  }

  .result-badge {
    font-size: 4rem;
    margin-bottom: 10px;
  }

  .result-title {
    font-size: 2.5rem;
    margin: 10px 0;
    font-weight: bold;
  }

  .result-subtitle {
    font-size: 1.2rem;
    opacity: 0.9;
  }

  .overall-score {
    margin: 20px 0;
    padding: 20px;
    background: white;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .score-number {
    font-size: 4rem;
    font-weight: bold;
    color: #667eea;
    margin: 10px 0;
  }

  .radar-chart-section {
    margin: 30px 0;
    padding: 30px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .chart-container {
    position: relative;
    height: 400px;
    margin: 20px auto;
  }

  .dimension-scores {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 30px 0;
  }

  .dimension-card {
    padding: 20px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-left: 5px solid;
  }

  .dimension-name {
    font-size: 1.1rem;
    font-weight: bold;
    margin-bottom: 10px;
  }

  .dimension-score-bar {
    width: 100%;
    height: 30px;
    background: #f0f0f0;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
  }

  .dimension-score-fill {
    height: 100%;
    border-radius: 15px;
    transition: width 1s ease-out;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    color: white;
    font-weight: bold;
  }

  .analysis-section {
    margin: 30px 0;
    padding: 30px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .section-title {
    font-size: 1.8rem;
    font-weight: bold;
    margin-bottom: 20px;
    color: #333;
    text-align: center !important;
    display: block;
    width: 100%;
  }

  .strength-weakness-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }

  .strength-card, .weakness-card {
    padding: 20px;
    border-radius: 10px;
  }

  .strength-card {
    background: #d4edda;
    border-left: 5px solid #28a745;
  }

  .weakness-card {
    background: #f8d7da;
    border-left: 5px solid #dc3545;
  }

  .risk-alert {
    padding: 20px;
    background: #fff3cd;
    border-left: 5px solid #ffc107;
    border-radius: 10px;
    margin: 15px 0;
  }

  .risk-alert.high {
    background: #f8d7da;
    border-left-color: #dc3545;
  }

  .recommendations {
    margin: 20px 0;
  }

  .recommendation-item {
    padding: 15px;
    margin: 10px 0;
    background: #e7f3ff;
    border-left: 5px solid #2196F3;
    border-radius: 10px;
  }

  .crisis-support {
    margin: 30px 0;
    padding: 25px;
    background: #ffe5e5;
    border: 2px solid #ff4444;
    border-radius: 15px;
  }

  .share-section {
    margin: 30px 0;
    padding: 25px;
    background: white;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .btn-share {
    padding: 12px 30px;
    border: none;
    border-radius: 25px;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .btn-share:hover {
    transform: scale(1.05);
  }
</style>

<!-- OG Tags for Social Sharing -->
<meta property="og:type" content="article">
<meta property="og:url" content="{{ .Permalink }}">
<meta property="og:title" content="{{ .Title }}">
<meta property="og:description" content="나의 종합 심리 분석 결과를 확인해보세요!">
{{ end }}

{{ define "main" }}
<div class="psychology-result-container">
  <!-- Result Header -->
  <div class="result-header">
    <div class="result-badge" id="resultBadge">🧠</div>
    <h1 class="result-title" id="resultTitle">심리 분석 결과</h1>
    <p class="result-subtitle" id="resultSubtitle">당신의 심리 상태를 분석했습니다</p>
  </div>

  <!-- Overall Score -->
  <div class="overall-score">
    <h3>종합 점수</h3>
    <div class="score-number" id="overallScore">--</div>
    <p id="scoreDescription">점수를 계산하는 중...</p>
  </div>

  <!-- Radar Chart -->
  <div class="radar-chart-section">
    <h2 class="section-title">📊 5대 차원 분석</h2>
    <div class="chart-container">
      <canvas id="radarChart"></canvas>
    </div>
  </div>

  <!-- Dimension Scores -->
  <div class="dimension-scores" id="dimensionScores">
    <!-- Populated by JavaScript -->
  </div>

  <!-- Strengths & Weaknesses -->
  <div class="analysis-section">
    <h2 class="section-title">💪 강점과 약점</h2>
    <div class="strength-weakness-grid" id="strengthWeakness">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <!-- Risk Alerts -->
  <div class="analysis-section" id="riskSection" style="display: none;">
    <h2 class="section-title">⚠️ 주의가 필요한 영역</h2>
    <div id="riskAlerts">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <!-- Recommendations -->
  <div class="analysis-section">
    <h2 class="section-title">💡 개선 제안</h2>
    <div class="recommendations" id="recommendations">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <!-- Crisis Support (shown if critical risks detected) -->
  <div class="crisis-support" id="crisisSupport" style="display: none;">
    <h3>🆘 긴급 지원이 필요하신가요?</h3>
    <p>심리적 어려움을 겪고 계시다면, 전문가의 도움을 받는 것을 권장합니다.</p>
    <div class="hotline-info">
      <div class="hotline-card">
        <div>💚 정신건강 위기상담</div>
        <div class="hotline-number">1577-0199</div>
        <small>24시간 운영</small>
      </div>
      <div class="hotline-card">
        <div>📞 자살예방 상담</div>
        <div class="hotline-number">1393</div>
        <small>24시간 운영</small>
      </div>
      <div class="hotline-card">
        <div>🏥 정신건강복지센터</div>
        <div class="hotline-number">1577-0199</div>
        <small>지역별 센터 안내</small>
      </div>
    </div>
  </div>

  <!-- Share Section -->
  <div class="share-section">
    <h3>💬 결과를 공유하기</h3>
    <p>친구들도 자신의 심리 상태를 확인해보세요!</p>
    <div class="share-buttons">
      <button class="btn-share" style="background: #FF6B6B; color: white;" onclick="downloadResultImage()">
        📸 이미지로 저장
      </button>
      <button class="btn-share" style="background: #3b5998; color: white;" onclick="shareFacebook()">
        📘 페이스북 공유
      </button>
      <button class="btn-share" style="background: #00acee; color: white;" onclick="shareTwitter()">
        🐦 트위터 공유
      </button>
      <button class="btn-share" style="background: #25D366; color: white;" onclick="copyLink(event)">
        🔗 링크 복사
      </button>
    </div>
  </div>

  <!-- Back to Test -->
  <div style="text-align: center; margin: 30px 0;">
    <a href="/psychology-center/comprehensive-analysis/" 
       style="display: inline-block; padding: 15px 40px; background: #667eea; color: white; 
              text-decoration: none; border-radius: 25px; font-weight: bold;">
      🔄 테스트 다시 하기
    </a>
  </div>
</div>
{{ end }}

{{ define "scripts" }}
<script src="/js/psychology-calculator.js"></script>
<script>
// Get test data and user answers from sessionStorage
const testDataJson = sessionStorage.getItem('psychologyTestData');
const answersJson = sessionStorage.getItem('psychologyAnswers');

if (!testDataJson || !answersJson) {
  alert('테스트 데이터를 찾을 수 없습니다. 테스트를 다시 시작해주세요.');
  window.location.href = '/psychology-center/comprehensive-analysis/';
}

const testData = JSON.parse(testDataJson);
const answers = JSON.parse(answersJson);

// Calculate results
const calculator = new PsychologyCalculator(testData);
const results = calculator.calculateResults(answers);

console.log('Analysis Results:', results);

// Update header
document.getElementById('resultBadge').textContent = getResultBadge(results.resultType);
document.getElementById('resultTitle').textContent = getResultTitle(results.resultType);
document.getElementById('resultSubtitle').textContent = getResultSubtitle(results.resultType);

// Update overall score
document.getElementById('overallScore').textContent = results.overallScore;
document.getElementById('scoreDescription').textContent = getScoreDescription(results.overallScore);

// Render radar chart
renderRadarChart(results.radarChartData);

// Display dimension scores
displayDimensionScores(results.dimensionScores);

// Display strengths and weaknesses
displayStrengthsWeaknesses(results.strengths, results.weaknesses);

// Display risks if any
if (results.risks.length > 0) {
  displayRisks(results.risks);
}

// Display recommendations
const recommendations = calculator.getRecommendations(results.dimensionScores, results.risks);
displayRecommendations(recommendations);

// Show crisis support if critical
const hasCriticalRisk = results.risks.some(r => r.severity === 'high');
if (hasCriticalRisk || results.overallScore < 35) {
  document.getElementById('crisisSupport').style.display = 'block';
}

/**
 * Render Chart.js radar chart
 */
function renderRadarChart(chartData) {
  const ctx = document.getElementById('radarChart').getContext('2d');
  
  new Chart(ctx, {
    type: 'radar',
    data: chartData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: {
            stepSize: 20
          }
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
}

/**
 * Display dimension scores as cards with progress bars
 */
function displayDimensionScores(dimensionScores) {
  const container = document.getElementById('dimensionScores');
  container.innerHTML = '';
  
  Object.entries(dimensionScores).forEach(([id, data]) => {
    const card = document.createElement('div');
    card.className = 'dimension-card';
    card.style.borderLeftColor = data.color;
    
    card.innerHTML = `
      <div class="dimension-name">${data.name}</div>
      <div class="dimension-score-bar">
        <div class="dimension-score-fill" 
             style="width: ${data.score}%; background: ${data.color};">
          ${data.score}점
        </div>
      </div>
    `;
    
    container.appendChild(card);
  });
}

/**
 * Display strengths and weaknesses with professional descriptions
 */
function displayStrengthsWeaknesses(strengths, weaknesses) {
  const container = document.getElementById('strengthWeakness');
  container.innerHTML = '';

  // Professional strength descriptions
  const strengthDescriptions = {
    '정서 건강': '감정을 잘 인식하고 조절하는 능력이 우수합니다. 이는 스트레스 상황에서도 균형을 유지하고, 타인과 건강한 관계를 형성하는 데 큰 도움이 됩니다.',
    '자기 관리': '목표 설정과 실행력이 뛰어나며, 자기 통제력이 강합니다. 이러한 역량은 장기적인 성공과 성취를 이루는 핵심 요소입니다.',
    '대인 관계': '타인과의 소통과 협력에 능숙하며, 공감 능력이 우수합니다. 이는 사회적 지지 네트워크를 구축하고 유지하는 데 큰 강점입니다.',
    '카리어 성장': '자신의 능력을 발전시키려는 의지가 강하며, 새로운 도전을 긍정적으로 받아들입니다. 이는 지속적인 성장과 발전의 원동력이 됩니다.',
    '생활 균형': '일과 휴식의 균형을 잘 맞추며, 전반적인 삶의 질이 높습니다. 이러한 균형감각은 장기적인 웰빙의 기초가 됩니다.'
  };

  // Professional growth area descriptions
  const growthDescriptions = {
    '정서 건강': '감정 조절에 어려움을 느끼는 경우가 있을 수 있습니다. 이는 매우 자연스러운 현상이며, 마음챙김 훈련이나 감정 일기 작성 등을 통해 점진적으로 개선할 수 있습니다.',
    '자기 관리': '목표 달성에 어려움을 겪거나 미루는 경향이 있을 수 있습니다. 작은 목표부터 시작하여 성취감을 쌓아가면, 자연스럽게 자기 관리 능력이 향상될 것입니다.',
    '대인 관계': '대인 관계에서 다소 불편함을 느끼는 경우가 있을 수 있습니다. 자신만의 속도로 관계를 발전시켜 나가되, 필요시 전문가의 도움을 받는 것도 좋은 방법입니다.',
    '카리어 성장': '진로나 커리어 방향에 대한 고민이 있을 수 있습니다. 다양한 경험을 시도해보고, 커리어 상담 등을 통해 자신의 강점과 관심사를 탐색해보시기를 권장합니다.',
    '생활 균형': '일과 생활의 균형을 맞추는 데 어려움이 있을 수 있습니다. 우선순위를 정하고, 자신을 위한 시간을 의식적으로 확보하는 연습이 도움이 될 것입니다.'
  };

  // Strengths
  const strengthsDiv = document.createElement('div');
  strengthsDiv.innerHTML = '<h3 style="color: #28a745; margin-bottom: 15px;">💪 심리적 강점</h3>';
  strengths.forEach(s => {
    const description = strengthDescriptions[s.name] || '이 영역에서 우수한 역량을 보이고 있습니다.';
    strengthsDiv.innerHTML += `
      <div class="strength-card">
        <strong style="font-size: 1.1rem;">${s.name}</strong>
        <div style="color: #28a745; font-weight: bold; margin: 5px 0;">${s.score}점 (상위 ${100 - Math.round(s.score)}%ile)</div>
        <p style="margin: 10px 0 0 0; line-height: 1.6;">${description}</p>
      </div>
    `;
  });
  container.appendChild(strengthsDiv);

  // Growth Areas (reframed from weaknesses)
  const weaknessesDiv = document.createElement('div');
  weaknessesDiv.innerHTML = '<h3 style="color: #e67e22; margin-bottom: 15px;">🌱 성장 가능 영역</h3>';
  weaknesses.forEach(w => {
    const description = growthDescriptions[w.name] || '이 영역에 조금 더 관심을 기울이면 좋은 변화를 경험하실 수 있습니다.';
    weaknessesDiv.innerHTML += `
      <div class="weakness-card" style="background: #fff3e0; border-left-color: #e67e22;">
        <strong style="font-size: 1.1rem;">${w.name}</strong>
        <div style="color: #e67e22; font-weight: bold; margin: 5px 0;">${w.score}점 (발전 잠재력: 높음)</div>
        <p style="margin: 10px 0 0 0; line-height: 1.6;">${description}</p>
      </div>
    `;
  });
  container.appendChild(weaknessesDiv);
}

/**
 * Display risk alerts with supportive, professional language
 */
function displayRisks(risks) {
  if (risks.length === 0) return;

  const section = document.getElementById('riskSection');
  const container = document.getElementById('riskAlerts');
  section.style.display = 'block';
  container.innerHTML = '';

  risks.forEach(risk => {
    const alert = document.createElement('div');
    alert.className = `risk-alert ${risk.severity}`;

    // More supportive messaging
    let title = risk.severity === 'high' ? '💙 특별한 관심이 필요한 영역' : '💛 주의 깊게 살펴볼 영역';
    let supportiveMessage = risk.message;

    // Add supportive context
    let actionAdvice = risk.severity === 'high'
      ? '<p style="margin-top: 10px; font-weight: normal;">전문가와 상담하시면 더 나은 대처 방법을 찾으실 수 있습니다. 도움을 요청하는 것은 강점이며, 자신을 돌보는 현명한 선택입니다.</p>'
      : '<p style="margin-top: 10px; font-weight: normal;">이 영역에 조금 더 주의를 기울이시면, 점진적인 개선을 경험하실 수 있습니다.</p>';

    alert.innerHTML = `
      <strong>${title}</strong><br>
      <p style="margin: 8px 0;">${supportiveMessage}</p>
      ${actionAdvice}
    `;
    container.appendChild(alert);
  });
}

/**
 * Display recommendations with specific, actionable advice
 */
function displayRecommendations(recommendations) {
  const container = document.getElementById('recommendations');
  container.innerHTML = '';

  if (recommendations.length === 0) {
    container.innerHTML = `
      <div class="recommendation-item" style="background: #e8f5e9; border-left-color: #4caf50;">
        <strong>✨ 훌륭합니다!</strong>
        <p style="margin: 10px 0 0 0;">현재 전반적으로 건강한 심리 상태를 유지하고 계십니다. 지금의 긍정적인 습관들을 계속 이어가시기 바랍니다.</p>
        <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
          <li>규칙적인 운동과 충분한 수면 유지하기</li>
          <li>의미 있는 관계에 시간 투자하기</li>
          <li>자신만의 스트레스 해소 방법 지속하기</li>
          <li>정기적인 자기 점검과 성찰 시간 갖기</li>
        </ul>
      </div>
    `;
    return;
  }

  // Enhanced recommendation templates with specific actions
  const enhancedRecommendations = recommendations.map(rec => {
    let specificActions = [];

    // Add specific, actionable steps based on recommendation type
    if (rec.message.includes('정서') || rec.message.includes('감정')) {
      specificActions = [
        '매일 5분 마음챙김 명상 실천하기',
        '감정 일기 작성으로 감정 패턴 파악하기',
        '깊은 호흡 연습으로 즉각적 안정감 얻기',
        '필요시 정신건강 전문가 상담 고려하기'
      ];
    } else if (rec.message.includes('관계') || rec.message.includes('대인')) {
      specificActions = [
        '주 1회 의미 있는 대화 시간 만들기',
        '경청과 공감 능력 향상 연습하기',
        '소셜 모임이나 관심사 기반 커뮤니티 참여하기',
        '갈등 상황에서 건설적 대화법 활용하기'
      ];
    } else if (rec.message.includes('목표') || rec.message.includes('관리')) {
      specificActions = [
        '작고 구체적인 목표부터 시작하기',
        '일일 우선순위 3가지 정하고 실천하기',
        '성취 일지 작성으로 동기 유지하기',
        '미루기 패턴 인식하고 대처 전략 세우기'
      ];
    } else {
      specificActions = [
        '하루 20분 이상 신체 활동하기',
        '충분한 수면 (7-8시간) 확보하기',
        '건강한 식습관과 규칙적인 생활 리듬 유지하기',
        '여가 활동과 휴식 시간 의식적으로 확보하기'
      ];
    }

    return {
      ...rec,
      specificActions
    };
  });

  // Sort by priority
  const sorted = enhancedRecommendations.sort((a, b) => {
    const priority = { high: 3, medium: 2, low: 1 };
    return priority[b.priority] - priority[a.priority];
  });

  sorted.forEach(rec => {
    const item = document.createElement('div');
    item.className = 'recommendation-item';

    const priorityIcon = rec.priority === 'high' ? '🎯' : '💫';
    const priorityText = rec.priority === 'high' ? '우선 추천' : '추천 사항';

    item.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <strong style="font-size: 1.1rem;">${priorityIcon} ${priorityText}</strong>
      </div>
      <p style="margin: 0 0 10px 0; font-weight: 500; color: #1976d2;">${rec.message}</p>
      <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 10px;">
        <strong style="font-size: 0.95rem;">💡 구체적인 실천 방법:</strong>
        <ul style="margin: 8px 0 0 20px; line-height: 1.8; color: #555;">
          ${rec.specificActions.map(action => `<li>${action}</li>`).join('')}
        </ul>
      </div>
    `;
    container.appendChild(item);
  });

  // Add general wellness tip at the end
  const wellnessTip = document.createElement('div');
  wellnessTip.className = 'recommendation-item';
  wellnessTip.style.background = '#f3e5f5';
  wellnessTip.style.borderLeftColor = '#9c27b0';
  wellnessTip.innerHTML = `
    <strong>🌸 웰빙 팁</strong>
    <p style="margin: 10px 0 0 0; line-height: 1.6;">
      심리 검사 결과는 현재 상태를 보여주는 하나의 지표일 뿐, 당신을 정의하지 않습니다.
      작은 변화부터 시작하되, 자신에게 너그러운 마음을 가지시기 바랍니다.
      개선은 직선이 아닌 곡선으로 이루어지며, 때로는 후퇴하는 것처럼 보일 수도 있습니다.
      이는 모두 성장 과정의 일부입니다. 💚
    </p>
  `;
  container.appendChild(wellnessTip);
}

/**
 * Get result badge emoji based on type
 */
function getResultBadge(type) {
  const badges = {
    'thriving': '🌟',
    'flourishing': '🌱',
    'stable': '⚖️',
    'struggling': '🔄',
    'critical': '🆘'
  };
  return badges[type] || '🧠';
}

/**
 * Get result title based on type
 */
function getResultTitle(type) {
  const titles = {
    'thriving': '번영하는 삶',
    'flourishing': '성장하는 삶',
    'stable': '안정적인 삶',
    'struggling': '도전받는 삶',
    'critical': '위기의 삶'
  };
  return titles[type] || '심리 분석 결과';
}

/**
 * Get result subtitle based on type
 */
function getResultSubtitle(type) {
  const subtitles = {
    'thriving': '모든 영역에서 균형잡힌 성장',
    'flourishing': '대부분의 영역에서 건강한 상태',
    'stable': '평균적이고 안정적인 상태',
    'struggling': '여러 영역에서 어려움을 겪고 있음',
    'critical': '즉각적인 관심과 지원이 필요'
  };
  return subtitles[type] || '';
}

/**
 * Get score description
 */
function getScoreDescription(score) {
  if (score >= 80) return '매우 건강한 심리 상태입니다!';
  if (score >= 65) return '전반적으로 좋은 상태입니다.';
  if (score >= 50) return '평균적인 수준입니다.';
  if (score >= 35) return '개선이 필요한 상태입니다.';
  return '전문가의 도움이 권장됩니다.';
}

/**
 * Social sharing functions
 */
function shareFacebook() {
  const url = encodeURIComponent(window.location.href);
  const text = encodeURIComponent('나의 종합 심리 분석 결과를 확인했어요! 당신도 해보세요!');
  window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank', 'width=600,height=400');
}

function shareTwitter() {
  const url = encodeURIComponent(window.location.href);
  const text = encodeURIComponent('나의 종합 심리 분석 결과! 5가지 차원에서 내 마음을 분석했어요 🧠✨');
  window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
}

function copyLink(event) {
  if (!event || !event.currentTarget) {
    console.error('Event object is invalid');
    alert('링크 복사에 실패했습니다. 다시 시도해주세요.');
    return;
  }

  const url = window.location.href;
  const text = `종합 심리 분석 결과\n\n${url}`;
  const btn = event.currentTarget;
  const originalText = btn.innerHTML;

  navigator.clipboard.writeText(text).then(() => {
    btn.innerHTML = '✅ 복사 완료!';
    setTimeout(() => {
      btn.innerHTML = originalText;
    }, 2000);
  }).catch(err => {
    console.error('Copy failed:', err);
    alert('링크 복사에 실패했습니다: ' + err.message);
  });
}

/**
 * Download result as image
 */
function downloadResultImage() {
  const btn = event.currentTarget;
  const originalText = btn.innerHTML;
  btn.innerHTML = '📸 생성 중...';
  btn.disabled = true;

  // Get the result container (excluding share buttons and back button)
  const container = document.querySelector('.psychology-result-container');

  // Temporarily hide share section and back button
  const shareSection = document.querySelector('.share-section');
  const backButton = shareSection.nextElementSibling;
  shareSection.style.display = 'none';
  backButton.style.display = 'none';

  html2canvas(container, {
    backgroundColor: '#f5f5f5',
    scale: 2, // Higher quality
    logging: false,
    useCORS: true
  }).then(canvas => {
    // Restore hidden elements
    shareSection.style.display = 'block';
    backButton.style.display = 'block';
    btn.innerHTML = originalText;
    btn.disabled = false;

    // Convert to blob and download
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `심리분석결과_${new Date().toISOString().slice(0,10)}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Show success message
      btn.innerHTML = '✅ 저장 완료!';
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    });
  }).catch(err => {
    shareSection.style.display = 'block';
    backButton.style.display = 'block';
    btn.innerHTML = originalText;
    btn.disabled = false;
    alert('이미지 생성에 실패했습니다: ' + err.message);
  });
}
</script>
{{ end }}
