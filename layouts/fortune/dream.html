{{ define "head" }}
<link rel="stylesheet" href="/css/fortune.css">
<style>
    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
        background: linear-gradient(180deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
        min-height: 100vh;
    }

    /* ì…ë ¥ í™”ë©´ */
    .fortune-input-container {
        max-width: 800px;
        margin: 60px auto;
        padding: 60px 40px;
        background: linear-gradient(135deg, rgba(30, 27, 75, 0.9), rgba(49, 46, 129, 0.9));
        border-radius: 32px;
        box-shadow: 0 20px 60px rgba(30, 27, 75, 0.4);
        border: 2px solid rgba(251, 191, 36, 0.3);
        position: relative;
        overflow: hidden;
    }

    .fortune-input-title {
        text-align: center;
        font-size: 2.5rem;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 16px;
        font-weight: 900;
    }

    .fortune-input-subtitle {
        text-align: center;
        color: #cbd5e1;
        font-size: 1.15rem;
        margin-bottom: 48px;
        line-height: 1.8;
    }

    .keyword-input-group {
        margin-bottom: 40px;
    }

    .keyword-input {
        width: 100%;
        padding: 20px;
        border-radius: 16px;
        border: 2px solid rgba(251, 191, 36, 0.3);
        background: rgba(15, 23, 42, 0.5);
        color: white;
        font-size: 1.15rem;
        text-align: left;
        transition: all 0.3s ease;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
        line-height: 1.7;
        resize: vertical;
        min-height: 150px;
    }

    .keyword-input::placeholder {
        color: rgba(255, 255, 255, 0.4);
        font-size: 1.05rem;
    }

    .keyword-input:focus {
        outline: none;
        border-color: #fbbf24;
        box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
    }

    .popular-keywords {
        margin-bottom: 40px;
    }

    .popular-keywords-title {
        text-align: center;
        color: #fbbf24;
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 20px;
    }

    .popular-keywords-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
    }

    .keyword-btn {
        padding: 16px 12px;
        background: rgba(251, 191, 36, 0.1);
        border: 1px solid rgba(251, 191, 36, 0.3);
        border-radius: 16px;
        color: #fbbf24;
        font-size: 1.05rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .keyword-btn:hover {
        background: rgba(251, 191, 36, 0.2);
        border-color: #fbbf24;
        transform: translateY(-2px);
    }

    .submit-button {
        display: block;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: #1e1b4b;
        border: none;
        border-radius: 50px;
        font-size: 1.3rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
    }

    .submit-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .submit-button:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 28px rgba(251, 191, 36, 0.5);
    }

    /* ê²°ê³¼ í™”ë©´ */
    .fortune-result-container {
        max-width: 900px;
        margin: 60px auto;
        padding: 60px 40px;
        background: linear-gradient(135deg, rgba(30, 27, 75, 0.9), rgba(49, 46, 129, 0.9));
        border-radius: 32px;
        box-shadow: 0 20px 60px rgba(30, 27, 75, 0.4);
        border: 2px solid rgba(251, 191, 36, 0.3);
    }

    .message-box {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
        border-left: 4px solid #fbbf24;
        border-radius: 12px;
        padding: 24px;
        color: #e2e8f0;
        font-size: 1.1rem;
        line-height: 1.9;
        margin-bottom: 24px;
    }

    .message-box-title {
        font-size: 1.2rem;
        color: #fbbf24;
        font-weight: 700;
        margin-bottom: 12px;
    }

    @media (max-width: 768px) {
        .fortune-input-container,
        .fortune-result-container {
            margin: 20px;
            padding: 40px 24px;
        }

        .popular-keywords-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>
{{ end }}

{{ define "main" }}
<div class="fortune-page">
    <div style="position: relative; z-index: 1;">

        <!-- ì…ë ¥ ì„¹ì…˜ -->
        <div id="inputSection" class="fortune-input-container">
            <h2 class="fortune-input-title">ğŸŒ™ ê¿ˆí•´ëª½</h2>
            <p class="fortune-input-subtitle">
                ì˜¤ëŠ˜ ê¾¼ ê¿ˆì˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì‹œë©´<br>
                ìƒì„¸í•œ ê¿ˆí•´ëª½ ê²°ê³¼ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤ âœ¨
            </p>

            <div class="keyword-input-group">
                <textarea id="dreamInput" class="keyword-input" rows="5"
                       placeholder="ê¿ˆ ë‚´ìš©ì„ ìì„¸íˆ ì…ë ¥í•˜ì„¸ìš”...&#10;&#10;ì˜ˆì‹œ: ì§‘ì—ì„œ ì ì„ ìê³  ìˆëŠ”ë° ê°‘ìê¸° ì°½ë¬¸ì—ì„œ ë¬¼ì´ ì—„ì²­ë‚˜ê²Œ í™ìˆ˜ì²˜ëŸ¼ ë“¤ì–´ì˜¤ë”ë‹ˆ ì§‘ì´ ë¬¼ì— ì ê¸°ê³  í•˜ì–€ ë±€ë“¤ì´ ì—„ì²­ë‚˜ê²Œ ë§ì´ ë‚˜íƒ€ë‚¬ì–´"></textarea>
            </div>

            <!-- ì¸ê¸° í‚¤ì›Œë“œ -->
            <div class="popular-keywords">
                <div class="popular-keywords-title">ğŸ”¥ ì¸ê¸° í‚¤ì›Œë“œ</div>
                <div class="popular-keywords-grid" id="popularKeywordsGrid"></div>
            </div>

            <button id="submitButton" class="submit-button">
                ê¿ˆ í•´ëª½í•˜ê¸°
            </button>
        </div>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div id="resultSection" class="fortune-result-container" style="display: none;">
            <!-- ìƒì§• í—¤ë” -->
            <div style="text-align: center; margin-bottom: 40px;">
                <div id="resultIcon" style="font-size: 6rem; margin-bottom: 20px; filter: drop-shadow(0 4px 12px rgba(251, 191, 36, 0.4));"></div>
                <h3 id="resultName" style="font-size: 2.2rem; color: #fbbf24; font-weight: 800; margin-bottom: 12px;"></h3>
                <div id="resultInfo" style="font-size: 1.1rem; color: #cbd5e1; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;"></div>
            </div>

            <!-- ì˜¤ëŠ˜ì˜ í–‰ìš´ ì§€ìˆ˜ -->
            <div style="text-align: center; background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.15)); border-radius: 24px; padding: 40px; margin-bottom: 40px; border: 2px solid rgba(251, 191, 36, 0.3);">
                <h4 style="font-size: 1.3rem; color: #fbbf24; margin-bottom: 16px; font-weight: 700;">ğŸŒŸ ì˜¤ëŠ˜ì˜ í–‰ìš´ ì§€ìˆ˜</h4>
                <div id="resultLuckyScore" style="font-size: 4rem; font-weight: 900; background: linear-gradient(135deg, #fbbf24, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"></div>
            </div>

            <!-- ìƒì„¸ í•´ëª½ ì•„ì½”ë””ì–¸ -->
            <div class="accordion-section" style="margin-bottom: 24px;">
                <button class="accordion-header" onclick="toggleAccordion('dreamMeaning')" style="width: 100%; background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.3))'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(251, 191, 36, 0.3)';" onmouseout="this.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2))'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <span style="font-size: 1.2rem; color: #fbbf24; font-weight: 700;">ğŸ“– ìƒì„¸ í•´ëª½ ë³´ê¸°</span>
                    <span class="accordion-icon" style="font-size: 1.5rem; color: #fbbf24; transition: transform 0.3s ease;">â–¼</span>
                </button>
                <div id="dreamMeaning" class="accordion-content" style="overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease;">
                    <div class="accordion-inner" style="padding-top: 20px;">
                        <!-- ê¿ˆì˜ ê¸°ë³¸ ì˜ë¯¸ -->
                        <div id="meaningSection" class="message-box">
                            <div class="message-box-title">ğŸ“– ê¿ˆì˜ ê¸°ë³¸ ì˜ë¯¸</div>
                            <div id="resultMeaning"></div>
                        </div>

                        <!-- ê¸ì •ì  ì˜ë¯¸ -->
                        <div id="positiveSection" class="message-box">
                            <div class="message-box-title">âœ¨ ê¸ì •ì  ì˜ë¯¸</div>
                            <div id="resultPositive"></div>
                        </div>

                        <!-- ë¶€ì •ì  ì˜ë¯¸ (ìˆëŠ” ê²½ìš°ë§Œ) -->
                        <div id="negativeSection" class="message-box" style="display: none;">
                            <div class="message-box-title">âš ï¸ ì£¼ì˜ì‚¬í•­</div>
                            <div id="resultNegative"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¡°ì–¸ & ë©”ì‹œì§€ ì•„ì½”ë””ì–¸ -->
            <div class="accordion-section" style="margin-bottom: 24px;">
                <button class="accordion-header" onclick="toggleAccordion('dreamAdvice')" style="width: 100%; background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.3))'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(251, 191, 36, 0.3)';" onmouseout="this.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2))'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <span style="font-size: 1.2rem; color: #fbbf24; font-weight: 700;">ğŸ’¡ ì¡°ì–¸ & ë©”ì‹œì§€ ë³´ê¸°</span>
                    <span class="accordion-icon" style="font-size: 1.5rem; color: #fbbf24; transition: transform 0.3s ease;">â–¼</span>
                </button>
                <div id="dreamAdvice" class="accordion-content" style="overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease;">
                    <div class="accordion-inner" style="padding-top: 20px;">
                        <!-- ì˜¤ëŠ˜ì˜ ì¡°ì–¸ -->
                        <div id="adviceSection" class="message-box">
                            <div class="message-box-title">ğŸ’¡ ì˜¤ëŠ˜ì˜ ì¡°ì–¸</div>
                            <div id="resultAdvice"></div>
                        </div>

                        <!-- íŠ¹ë³„ ë©”ì‹œì§€ -->
                        <div id="todayAdviceSection" class="message-box">
                            <div class="message-box-title">ğŸ”® íŠ¹ë³„ ë©”ì‹œì§€</div>
                            <div id="resultTodayAdvice"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í–‰ìš´ì˜ ì•„ì´í…œ ì•„ì½”ë””ì–¸ -->
            <div class="accordion-section" style="margin-bottom: 40px;">
                <button class="accordion-header" onclick="toggleAccordion('luckyItems')" style="width: 100%; background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2)); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.3))'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(251, 191, 36, 0.3)';" onmouseout="this.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2))'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <span style="font-size: 1.2rem; color: #fbbf24; font-weight: 700;">ğŸ€ í–‰ìš´ì˜ ì•„ì´í…œ ë³´ê¸°</span>
                    <span class="accordion-icon" style="font-size: 1.5rem; color: #fbbf24; transition: transform 0.3s ease;">â–¼</span>
                </button>
                <div id="luckyItems" class="accordion-content" style="overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease;">
                    <div class="accordion-inner" style="padding-top: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="background: rgba(251, 191, 36, 0.1); border-radius: 16px; padding: 24px; text-align: center; border: 1px solid rgba(251, 191, 36, 0.2);">
                                <div style="font-size: 1.8rem; margin-bottom: 8px;">ğŸ¨</div>
                                <div style="font-size: 0.95rem; color: #94a3b8; margin-bottom: 8px;">í–‰ìš´ì˜ ìƒ‰</div>
                                <div id="resultLuckyColor" style="font-size: 1.3rem; color: #fbbf24; font-weight: 700;"></div>
                            </div>
                            <div style="background: rgba(251, 191, 36, 0.1); border-radius: 16px; padding: 24px; text-align: center; border: 1px solid rgba(251, 191, 36, 0.2);">
                                <div style="font-size: 1.8rem; margin-bottom: 8px;">ğŸ”¢</div>
                                <div style="font-size: 0.95rem; color: #94a3b8; margin-bottom: 8px;">í–‰ìš´ì˜ ìˆ«ì</div>
                                <div id="resultLuckyNumber" style="font-size: 1.3rem; color: #fbbf24; font-weight: 700;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ê³µìœ í•˜ê¸° ì„¹ì…˜ -->
            <div class="share-section-fortune" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.15)); border-radius: 20px; padding: 36px; text-align: center; border: 2px solid rgba(251, 191, 36, 0.3);">
                <h4 style="font-size: 1.4rem; color: #fbbf24; margin-bottom: 24px; font-weight: 800;">ğŸ’¬ ê²°ê³¼ë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ê¸°</h4>
                <div style="display: flex; justify-content: center; gap: 16px; flex-wrap: wrap;">
                    <button onclick="downloadDreamImage()" style="padding: 14px 32px; background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border: none; border-radius: 50px; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 16px rgba(245, 87, 108, 0.3);" id="downloadBtn">
                        <span style="font-size: 1.3rem;">ğŸ“¸</span> <span class="download-text">ì´ë¯¸ì§€ ì €ì¥</span>
                    </button>
                    <button onclick="shareFacebook()" style="padding: 14px 32px; background: linear-gradient(135deg, #3b5998, #2d4373); color: white; border: none; border-radius: 50px; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 16px rgba(59, 89, 152, 0.3);">
                        <span style="font-size: 1.3rem;">ğŸ“˜</span> í˜ì´ìŠ¤ë¶ ê³µìœ 
                    </button>
                    <button onclick="copyLink()" style="padding: 14px 32px; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #1e1b4b; border: none; border-radius: 50px; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 16px rgba(251, 191, 36, 0.3);" id="copyBtn">
                        <span style="font-size: 1.3rem;">ğŸ”—</span> ë§í¬ ë³µì‚¬
                    </button>
                </div>
            </div>

            <!-- ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼ -->
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="resetDream()" style="padding: 14px 40px; background: transparent; color: #fbbf24; border: 2px solid #fbbf24; border-radius: 50px; font-size: 1.05rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">
                    â†» ë‹¤ë¥¸ ê¿ˆ í•´ëª½í•˜ê¸°
                </button>
            </div>
        </div>

    </div>
</div>

<script src="/js/fortune-engine.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    const dreamInput = document.getElementById('dreamInput');
    const submitButton = document.getElementById('submitButton');
    const inputSection = document.getElementById('inputSection');
    const resultSection = document.getElementById('resultSection');

    // ì¸ê¸° í‚¤ì›Œë“œ ë Œë”ë§
    const popularKeywords = getPopularDreamKeywords();
    const popularKeywordsGrid = document.getElementById('popularKeywordsGrid');

    popularKeywords.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'keyword-btn';
        btn.innerHTML = `${item.icon}<br>${item.name}`;
        btn.onclick = () => {
            dreamInput.value = item.name;
            dreamInput.focus();
        };
        popularKeywordsGrid.appendChild(btn);
    });

    // ê²€ìƒ‰ ë²„íŠ¼
    submitButton.addEventListener('click', showDreamInterpretation);

    function showDreamInterpretation() {
        const dreamText = dreamInput.value.trim();

        if (!dreamText) {
            alert('ê¿ˆ ë‚´ìš©ì´ë‚˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        console.log('ê¿ˆ ë¶„ì„:', dreamText);

        try {
            const result = getAdvancedDreamInterpretation(dreamText);
            console.log('í•´ëª½ ê²°ê³¼:', result);

            if (!result.found) {
                alert(result.message);
                return;
            }

            // ê²°ê³¼ ë Œë”ë§
            renderDreamResult(result);

            // í™”ë©´ ì „í™˜
            inputSection.style.display = 'none';
            resultSection.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // ì•„ì½”ë””ì–¸ ì´ˆê¸°í™”
            setTimeout(() => {
                initializeAccordions();
            }, 100);

        } catch (error) {
            console.error('ê¿ˆí•´ëª½ ì˜¤ë¥˜:', error);
            alert('ê¿ˆí•´ëª½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    }

    function renderDreamResult(result) {
        // ê³ ê¸‰ ë¶„ì„ì¸ ê²½ìš°
        if (result.isAdvanced) {
            renderAdvancedResult(result);
        }
    }

    function renderAdvancedResult(result) {
        // í—¤ë” ì—…ë°ì´íŠ¸
        document.getElementById('resultIcon').textContent = 'ğŸ”®';
        document.getElementById('resultName').textContent = 'ì¢…í•© ê¿ˆí•´ëª½';
        document.getElementById('resultInfo').innerHTML = `
            <span><strong>ë°œê²¬ëœ ìƒì§•:</strong> ${result.totalCount}ê°œ</span>
            <span><strong>ë‚ ì§œ:</strong> ${result.dateKorean}</span>
        `;

        // í–‰ìš´ ì ìˆ˜
        document.getElementById('resultLuckyScore').textContent = result.luckyScore + 'ì ';

        // ê¸°ë³¸ ìƒì§•ë“¤ í‘œì‹œ
        let symbolsHtml = '<div style="margin-bottom: 30px;">';
        symbolsHtml += '<h4 style="color: #fbbf24; font-size: 1.2rem; margin-bottom: 16px;">âœ¨ ë°œê²¬ëœ ê¿ˆ ìƒì§•</h4>';
        symbolsHtml += '<div style="display: grid; gap: 16px;">';

        result.symbols.forEach(item => {
            const s = item.data;
            symbolsHtml += `
                <div style="background: rgba(251, 191, 36, 0.1); padding: 20px; border-radius: 16px; border-left: 4px solid #fbbf24;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <span style="font-size: 2rem;">${s.icon}</span>
                        <h5 style="font-size: 1.3rem; color: #fbbf24; margin: 0;">${s.name}</h5>
                    </div>
                    <p style="color: #e2e8f0; margin: 8px 0; line-height: 1.7;"><strong>ê¸°ë³¸ ì˜ë¯¸:</strong> ${s.meaning}</p>
                    <p style="color: #e2e8f0; margin: 8px 0; line-height: 1.7;"><strong>ê¸ì •ì  í•´ì„:</strong> ${s.positive}</p>
                    ${s.negative ? `<p style="color: #fca5a5; margin: 8px 0; line-height: 1.7;"><strong>ì£¼ì˜ì‚¬í•­:</strong> ${s.negative}</p>` : ''}
                </div>
            `;
        });

        symbolsHtml += '</div></div>';

        // ìƒ‰ìƒ ì •ë³´
        if (result.colors.length > 0) {
            symbolsHtml += '<div style="margin-bottom: 30px;">';
            symbolsHtml += '<h4 style="color: #fbbf24; font-size: 1.2rem; margin-bottom: 16px;">ğŸ¨ ìƒ‰ìƒì˜ ì˜ë¯¸</h4>';
            symbolsHtml += '<div style="display: grid; gap: 12px;">';

            result.colors.forEach(item => {
                const c = item.data;
                symbolsHtml += `
                    <div style="background: rgba(251, 191, 36, 0.08); padding: 16px; border-radius: 12px;">
                        <h5 style="font-size: 1.15rem; color: #fbbf24; margin: 0 0 8px 0;">${c.name}</h5>
                        <p style="color: #cbd5e1; margin: 4px 0; line-height: 1.6;">${c.meaning}</p>
                        <p style="color: #e2e8f0; margin: 4px 0; line-height: 1.6;"><strong>íš¨ê³¼:</strong> ${c.effect}</p>
                    </div>
                `;
            });

            symbolsHtml += '</div></div>';
        }

        // ìƒí™© ì •ë³´
        if (result.situations.length > 0) {
            symbolsHtml += '<div style="margin-bottom: 30px;">';
            symbolsHtml += '<h4 style="color: #fbbf24; font-size: 1.2rem; margin-bottom: 16px;">ğŸ“ ìƒí™©ì˜ ì˜ë¯¸</h4>';
            symbolsHtml += '<div style="display: grid; gap: 12px;">';

            result.situations.forEach(item => {
                const sit = item.data;
                symbolsHtml += `
                    <div style="background: rgba(251, 191, 36, 0.08); padding: 16px; border-radius: 12px;">
                        <h5 style="font-size: 1.15rem; color: #fbbf24; margin: 0 0 8px 0;">${sit.name}</h5>
                        <p style="color: #cbd5e1; margin: 4px 0; line-height: 1.6;">${sit.meaning}</p>
                        <p style="color: #e2e8f0; margin: 4px 0; line-height: 1.6;"><strong>íš¨ê³¼:</strong> ${sit.effect}</p>
                    </div>
                `;
            });

            symbolsHtml += '</div></div>';
        }

        document.getElementById('resultMeaning').innerHTML = symbolsHtml;

        // ì¢…í•© í•´ì„
        document.getElementById('resultPositive').innerHTML = `
            <h4 style="color: #fbbf24; font-size: 1.2rem; margin-bottom: 12px;">ğŸ”® ì¢…í•© í•´ì„</h4>
            <p style="color: #e2e8f0; line-height: 1.9; white-space: pre-line;">${result.comprehensiveAnalysis}</p>
        `;

        // ë¶€ì •ì  ì˜ë¯¸ ì„¹ì…˜ ìˆ¨ê¹€ (ì¢…í•© í•´ì„ì— í¬í•¨ë¨)
        document.getElementById('negativeSection').style.display = 'none';

        // ì¡°ì–¸ ì„¹ì…˜ ìˆ¨ê¹€ (ì¢…í•© í•´ì„ì— í¬í•¨ë¨)
        document.getElementById('adviceSection').style.display = 'none';

        // íŠ¹ë³„ ë©”ì‹œì§€
        const specialMessage = `ì˜¤ëŠ˜ ${result.totalCount}ê°œì˜ ê¿ˆ ìƒì§•ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ë§¤ìš° í’ë¶€í•œ ì˜ë¯¸ë¥¼ ë‹´ê³  ìˆëŠ” ê¿ˆì…ë‹ˆë‹¤. ${result.comprehensiveAnalysis.includes('ê¸¸í•œ') || result.comprehensiveAnalysis.includes('ì¢‹ì€') ? 'í° í–‰ìš´ì´ í•¨ê»˜í•˜ê¸¸ ë°”ëë‹ˆë‹¤!' : 'ê¿ˆì˜ ë©”ì‹œì§€ì— ê·€ ê¸°ìš¸ì´ì„¸ìš”.'}`;
        document.getElementById('resultTodayAdvice').textContent = specialMessage;

        // í–‰ìš´ì˜ ì•„ì´í…œ
        document.getElementById('resultLuckyColor').textContent = result.luckyColor.name;
        document.getElementById('resultLuckyNumber').textContent = result.luckyNumber;
    }

    // ë‹¤ì‹œí•˜ê¸°
    function resetDream() {
        inputSection.style.display = 'block';
        resultSection.style.display = 'none';
        dreamInput.value = '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // í˜ì´ìŠ¤ë¶ ê³µìœ 
    function shareFacebook() {
        const url = encodeURIComponent(window.location.href);
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=600,height=400');
    }

    // ë§í¬ ë³µì‚¬
    function copyLink() {
        const copyBtn = document.getElementById('copyBtn');
        const url = window.location.href;

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(url).then(() => {
                copyBtn.innerHTML = '<span style="font-size: 1.3rem;">âœ…</span> ë³µì‚¬ ì™„ë£Œ!';
                setTimeout(() => {
                    copyBtn.innerHTML = '<span style="font-size: 1.3rem;">ğŸ”—</span> ë§í¬ ë³µì‚¬';
                }, 2000);
            }).catch(() => {
                fallbackCopyLink(url, copyBtn);
            });
        } else {
            fallbackCopyLink(url, copyBtn);
        }
    }

    function fallbackCopyLink(url, btn) {
        const textArea = document.createElement('textarea');
        textArea.value = url;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();

        try {
            document.execCommand('copy');
            btn.innerHTML = '<span style="font-size: 1.3rem;">âœ…</span> ë³µì‚¬ ì™„ë£Œ!';
            setTimeout(() => {
                btn.innerHTML = '<span style="font-size: 1.3rem;">ğŸ”—</span> ë§í¬ ë³µì‚¬';
            }, 2000);
        } catch (err) {
            alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì£¼ì†Œì°½ì˜ URLì„ ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
        }

        document.body.removeChild(textArea);
    }

    // ì´ë¯¸ì§€ ì €ì¥ í•¨ìˆ˜
    async function downloadDreamImage() {
        const downloadBtn = document.querySelector('.download-text');
        if (downloadBtn) {
            downloadBtn.textContent = 'ìƒì„± ì¤‘...';
        }

        try {
            if (typeof html2canvas === 'undefined') {
                throw new Error('html2canvasê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }

            const resultContainer = document.querySelector('.fortune-result-container');
            if (!resultContainer) {
                throw new Error('ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            // ê³µìœ  ë²„íŠ¼ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const shareSection = document.querySelector('.share-section-fortune');
            const originalDisplay = shareSection ? shareSection.style.display : '';
            if (shareSection) shareSection.style.display = 'none';

            // ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const resetBtn = resultContainer.nextElementSibling;
            const resetBtnDisplay = resetBtn ? resetBtn.style.display : '';
            if (resetBtn && resetBtn.querySelector('button[onclick="resetDream()"]')) {
                resetBtn.style.display = 'none';
            }

            // ë°°ê²½ìƒ‰ ì„ì‹œ ì„¤ì •
            const originalBg = resultContainer.style.background;
            resultContainer.style.background = 'linear-gradient(135deg, #1e1b4b, #312e81)';

            // ë¸Œëœë“œ ì›Œí„°ë§ˆí¬ ì¶”ê°€
            const watermark = document.createElement('div');
            watermark.style.cssText = 'text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(251, 191, 36, 0.3); font-size: 14px; color: #fbbf24; font-weight: 600;';
            watermark.innerHTML = 'âœ¨ natest.krì—ì„œ ë” ë§ì€ ìš´ì„¸ë¥¼ í™•ì¸í•˜ì„¸ìš”!';
            resultContainer.appendChild(watermark);

            // html2canvasë¡œ ìº¡ì²˜
            const canvas = await html2canvas(resultContainer, {
                backgroundColor: '#1e1b4b',
                scale: 2,
                logging: false,
                useCORS: true,
                allowTaint: true,
                width: resultContainer.scrollWidth,
                height: resultContainer.scrollHeight
            });

            // ì›Œí„°ë§ˆí¬ ì œê±°
            resultContainer.removeChild(watermark);

            // ê³µìœ  ë²„íŠ¼ ì„¹ì…˜ ë³µì›
            if (shareSection) shareSection.style.display = originalDisplay;

            // ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼ ë³µì›
            if (resetBtn) resetBtn.style.display = resetBtnDisplay;

            // ë°°ê²½ ë³µì›
            resultContainer.style.background = originalBg;

            // Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜
            canvas.toBlob((blob) => {
                if (!blob) {
                    throw new Error('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                // íŒŒì¼ëª… ìƒì„±
                const dreamName = document.getElementById('resultName').textContent || 'ê¿ˆí•´ëª½';
                const today = new Date();
                const dateStr = `${today.getMonth() + 1}ì›”${today.getDate()}ì¼`;
                const fileName = `${dreamName}_${dateStr}.png`;

                // ë‹¤ìš´ë¡œë“œ
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                if (downloadBtn) {
                    downloadBtn.textContent = 'ì €ì¥ ì™„ë£Œ!';
                    setTimeout(() => {
                        downloadBtn.textContent = 'ì´ë¯¸ì§€ ì €ì¥';
                    }, 2000);
                }
            }, 'image/png');

        } catch (error) {
            console.error('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');

            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µì›
            if (downloadBtn) {
                downloadBtn.textContent = 'ì´ë¯¸ì§€ ì €ì¥';
            }
        }
    }

    // ì•„ì½”ë””ì–¸ ì‹œìŠ¤í…œ
    function toggleAccordion(id) {
        const content = document.getElementById(id);
        const button = content.previousElementSibling;
        const icon = button.querySelector('.accordion-icon');

        if (content.style.maxHeight && content.style.maxHeight !== '0px') {
            // ì ‘ê¸°
            content.style.maxHeight = '0px';
            content.style.opacity = '0';
            content.style.paddingTop = '0';
            content.style.paddingBottom = '0';
            icon.style.transform = 'rotate(0deg)';
            button.setAttribute('aria-expanded', 'false');
        } else {
            // í¼ì¹˜ê¸°
            content.style.maxHeight = content.scrollHeight + 'px';
            content.style.opacity = '1';
            content.style.paddingTop = '0';
            content.style.paddingBottom = '0';
            icon.style.transform = 'rotate(180deg)';
            button.setAttribute('aria-expanded', 'true');

            // ì•½ê°„ì˜ ì—¬ìœ  ê³µê°„ ì¶”ê°€
            setTimeout(() => {
                content.style.maxHeight = (content.scrollHeight + 50) + 'px';
            }, 100);
        }
    }

    function initializeAccordions() {
        const isMobile = window.innerWidth <= 768;
        const accordions = ['dreamMeaning', 'dreamAdvice', 'luckyItems'];

        accordions.forEach(id => {
            const content = document.getElementById(id);
            const button = content.previousElementSibling;
            const icon = button.querySelector('.accordion-icon');

            if (isMobile) {
                // ëª¨ë°”ì¼: ê¸°ë³¸ ì ‘í˜
                content.style.maxHeight = '0px';
                content.style.opacity = '0';
                icon.style.transform = 'rotate(0deg)';
                button.setAttribute('aria-expanded', 'false');
            } else {
                // PC: ê¸°ë³¸ í¼ì¹¨
                content.style.maxHeight = (content.scrollHeight + 50) + 'px';
                content.style.opacity = '1';
                icon.style.transform = 'rotate(180deg)';
                button.setAttribute('aria-expanded', 'true');
            }
        });
    }

    // Resize handler with debounce
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            const accordions = ['dreamMeaning', 'dreamAdvice', 'luckyItems'];
            accordions.forEach(id => {
                const content = document.getElementById(id);
                if (content.style.opacity === '1') {
                    content.style.maxHeight = (content.scrollHeight + 50) + 'px';
                }
            });
        }, 250);
    });
</script>

{{ end }}
