<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- SEO Meta Tags -->
    <title>{{ if .IsHome }}{{ .Site.Title }}{{ else }}{{ .Title }} | {{ .Site.Title }}{{ end }}</title>
    <meta name="description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    <meta name="keywords" content="{{ if .Params.keywords }}{{ delimit .Params.keywords ", " }}{{ else }}{{ .Site.Params.keywords }}{{ end }}">
    <meta name="author" content="{{ .Site.Params.author }}">
    <link rel="canonical" href="{{ .Permalink }}" />
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />

    <!-- Naver Search Advisor Verification -->
    <meta name="naver-site-verification" content="7e7758458c6c274871a58ba9d901b0d6f29d0f3e" />

    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ .Permalink }}">
    <meta property="og:title" content="{{ if .IsHome }}{{ .Site.Title }}{{ else }}{{ .Title }}{{ end }}">
    <meta property="og:description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    <meta property="og:image" content="{{ .Site.BaseURL }}{{ if .Params.ogImage }}{{ strings.TrimPrefix "/" .Params.ogImage }}{{ else }}images/og-image.jpg{{ end }}">
    <meta property="og:site_name" content="{{ .Site.Title }}">
    <meta property="og:locale" content="ko_KR">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ if .IsHome }}{{ .Site.Title }}{{ else }}{{ .Title }}{{ end }}">
    <meta name="twitter:description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    <meta name="twitter:image" content="{{ .Site.BaseURL }}{{ if .Params.ogImage }}{{ strings.TrimPrefix "/" .Params.ogImage }}{{ else }}images/og-image.jpg{{ end }}">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="{{ .Site.Title }}">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/images/icon-512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/viral.css">
    <link rel="stylesheet" href="/css/modern-ui.css">
    {{ block "head" . }}{{ end }}

    <!-- Schema.org Structured Data -->
    {{ partial "schema.html" . }}

    <!-- Google Analytics -->
    {{ if .Site.Params.googleAnalytics }}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ .Site.Params.googleAnalytics }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{ .Site.Params.googleAnalytics }}');
    </script>
    {{ end }}
</head>
<body>
    {{ partial "header.html" . }}

    <main>
        {{ block "main" . }}{{ end }}
    </main>

    <!-- ëª¨ë°”ì¼ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    {{ $isFortuneSection := or (eq .Section "fortune") (hasPrefix .RelPermalink "/fortune/") }}
    {{ $isMyResults := hasPrefix .RelPermalink "/my-results/" }}
    {{ $isBadges := hasPrefix .RelPermalink "/my-badges/" }}
    {{ $isHome := and .IsHome (not $isFortuneSection) }}

    <nav class="mobile-bottom-nav" style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(180deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.98)); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-around; align-items: center; padding: 8px 0 calc(8px + env(safe-area-inset-bottom)); z-index: 1000; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);">

        <!-- í™ˆ (ì‹¬ë¦¬í…ŒìŠ¤íŠ¸) -->
        <a href="/" class="nav-item {{ if $isHome }}active{{ end }}" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: {{ if $isHome }}#667eea{{ else }}rgba(255,255,255,0.6){{ end }}; padding: 8px 16px; transition: all 0.3s ease; flex: 1; max-width: 100px;">
            <span style="font-size: 1.5rem; margin-bottom: 4px; transition: transform 0.3s ease; {{ if $isHome }}transform: scale(1.1);{{ end }}">ğŸ¯</span>
            <span style="font-size: 0.7rem; font-weight: {{ if $isHome }}700{{ else }}500{{ end }}; letter-spacing: -0.02em;">ì‹¬ë¦¬í…ŒìŠ¤íŠ¸</span>
        </a>

        <!-- ìš´ì„¸ -->
        <a href="/fortune/" class="nav-item {{ if $isFortuneSection }}active{{ end }}" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: {{ if $isFortuneSection }}#fbbf24{{ else }}rgba(255,255,255,0.6){{ end }}; padding: 8px 16px; transition: all 0.3s ease; flex: 1; max-width: 100px;">
            <span style="font-size: 1.5rem; margin-bottom: 4px; transition: transform 0.3s ease; {{ if $isFortuneSection }}transform: scale(1.1);{{ end }}">ğŸŒ™</span>
            <span style="font-size: 0.7rem; font-weight: {{ if $isFortuneSection }}700{{ else }}500{{ end }}; letter-spacing: -0.02em;">ìš´ì„¸</span>
        </a>

        <!-- ë‚´ ê²°ê³¼ -->
        <a href="/my-results/" class="nav-item {{ if $isMyResults }}active{{ end }}" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: {{ if $isMyResults }}#8b5cf6{{ else }}rgba(255,255,255,0.6){{ end }}; padding: 8px 16px; transition: all 0.3s ease; flex: 1; max-width: 100px; position: relative;">
            <span style="font-size: 1.5rem; margin-bottom: 4px; transition: transform 0.3s ease; {{ if $isMyResults }}transform: scale(1.1);{{ end }}">ğŸ“‹</span>
            <span style="font-size: 0.7rem; font-weight: {{ if $isMyResults }}700{{ else }}500{{ end }}; letter-spacing: -0.02em;">ë‚´ ê²°ê³¼</span>
            <span id="mobileResultsBadge" style="position: absolute; top: 4px; right: 8px; background: #ef4444; color: white; font-size: 0.65rem; padding: 2px 5px; border-radius: 10px; font-weight: 700; display: none;"></span>
        </a>

        <!-- ë±ƒì§€ -->
        <a href="/my-badges/" class="nav-item {{ if $isBadges }}active{{ end }}" style="display: flex; flex-direction: column; align-items: center; text-decoration: none; color: {{ if $isBadges }}#f59e0b{{ else }}rgba(255,255,255,0.6){{ end }}; padding: 8px 16px; transition: all 0.3s ease; flex: 1; max-width: 100px; position: relative;">
            <span style="font-size: 1.5rem; margin-bottom: 4px; transition: transform 0.3s ease; {{ if $isBadges }}transform: scale(1.1);{{ end }}">ğŸ†</span>
            <span style="font-size: 0.7rem; font-weight: {{ if $isBadges }}700{{ else }}500{{ end }}; letter-spacing: -0.02em;">ë±ƒì§€</span>
            <span id="mobileBadgesBadge" style="position: absolute; top: 4px; right: 8px; background: #f59e0b; color: white; font-size: 0.65rem; padding: 2px 5px; border-radius: 10px; font-weight: 700; display: none;"></span>
        </a>
    </nav>

    <style>
        /* ëª¨ë°”ì¼ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ - 768px ì´í•˜ì—ì„œë§Œ í‘œì‹œ */
        .mobile-bottom-nav {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-bottom-nav {
                display: flex;
            }

            /* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë†’ì´ë§Œí¼ bodyì— íŒ¨ë”© ì¶”ê°€ */
            body {
                padding-bottom: calc(70px + env(safe-area-inset-bottom));
            }

            /* ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œ í˜¸ë²„ íš¨ê³¼ */
            .mobile-bottom-nav .nav-item:active {
                transform: scale(0.95);
            }
        }

        /* iOS Safe Area ì§€ì› */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            @media (max-width: 768px) {
                body {
                    padding-bottom: calc(70px + env(safe-area-inset-bottom));
                }
            }
        }
    </style>

    <script>
        // ëª¨ë°”ì¼ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë±ƒì§€ ì—…ë°ì´íŠ¸
        (function() {
            // ë‚´ ê²°ê³¼ ë±ƒì§€
            const savedResults = JSON.parse(localStorage.getItem('test_results') || '{}');
            const resultsCount = Object.keys(savedResults).length;
            const mobileResultsBadge = document.getElementById('mobileResultsBadge');

            if (mobileResultsBadge && resultsCount > 0) {
                mobileResultsBadge.textContent = resultsCount;
                mobileResultsBadge.style.display = 'block';
            }

            // ë±ƒì§€ ì»¬ë ‰ì…˜ ë±ƒì§€
            try {
                const unlockedBadges = JSON.parse(localStorage.getItem('user_badges') || '[]');
                const mobileBadgesBadge = document.getElementById('mobileBadgesBadge');

                if (mobileBadgesBadge && unlockedBadges.length > 0) {
                    mobileBadgesBadge.textContent = unlockedBadges.length;
                    mobileBadgesBadge.style.display = 'block';
                }
            } catch (e) {
                console.error('Failed to update mobile badges badge:', e);
            }
        })();
    </script>

    <!-- Bookmark Popup -->
    <div id="bookmarkPopup" class="bookmark-popup" style="display: none;">
        <h4>â­ ë¶ë§ˆí¬ ì¶”ê°€</h4>
        <p>ìì£¼ ì‚¬ìš©í•˜ì‹œë‚˜ìš”? ë¶ë§ˆí¬ì— ì¶”ê°€í•˜ê³  ë¹ ë¥´ê²Œ ì ‘ì†í•˜ì„¸ìš”!</p>
        <div class="bookmark-popup-buttons">
            <button class="btn-bookmark-yes" onclick="closeBookmarkPopup(true)">ì¶”ê°€í•˜ê¸°</button>
            <button class="btn-bookmark-no" onclick="closeBookmarkPopup(false)">ë‚˜ì¤‘ì—</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="/js/test-engine.js"></script>
    <script src="/js/badge-system.js"></script>
    <script src="/js/result-stats.js"></script>
    {{ block "scripts" . }}{{ end }}

    <!-- Viral Features Script -->
    <script>
        // ë¶ë§ˆí¬ íŒì—… í‘œì‹œ (3ë²ˆì§¸ ë°©ë¬¸)
        function showBookmarkPopup() {
            const visitKey = 'test_hub_visit_count';
            const dismissKey = 'test_hub_bookmark_dismissed';

            let visitCount = parseInt(localStorage.getItem(visitKey)) || 0;
            visitCount++;
            localStorage.setItem(visitKey, visitCount);

            const dismissed = localStorage.getItem(dismissKey);

            if (visitCount >= 3 && !dismissed) {
                setTimeout(() => {
                    document.getElementById('bookmarkPopup').style.display = 'block';
                }, 2000);
            }
        }

        function closeBookmarkPopup(addBookmark) {
            document.getElementById('bookmarkPopup').style.display = 'none';
            localStorage.setItem('test_hub_bookmark_dismissed', 'true');

            if (addBookmark) {
                alert('Ctrl+D (Windows) ë˜ëŠ” Cmd+D (Mac)ë¥¼ ëˆŒëŸ¬ ë¶ë§ˆí¬ì— ì¶”ê°€í•˜ì„¸ìš”!');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.addEventListener('load', showBookmarkPopup);
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>
